<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: First steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/first-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">First steps in LHCb</h1>
          <h2 class="subtitle">Fun with LoKi Functors</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Understand what LoKi functors are</li>
<li>Use LoKi functors interactively</li>
<li>Be able to find functors that do what we want</li>
</ul>
</div>
</div>
<p>LoKi functors are designed to flexibly compute and compare properties of the current decay, from simple quantities such as the transverse momentum of particle to complicated ones like helicity angles. Internally, functors are implemented as C++ classes that take an object of type <code>TYPE1</code> and return another of <code>TYPE2</code>. They can be used both in C++ and in python code, and can be combined with each other using logical operations.</p>
<p>According to <code>TYPE2</code> there are 3 types of functors:</p>
<ul>
<li><em>Functions</em>, which return <code>double</code>.</li>
<li><em>Predicates</em>, which return a <code>bool</code>.</li>
<li><em>Streamers</em>, which return a <code>std::vector</code> of some other type <code>TYPE3</code>.</li>
</ul>
<p>When filling tuples, the most used functors are functions, while predicates are typically used for selections.</p>
<p>According to <code>TYPE1</code>, there are many types of functors, the most important of which are (you can find a full list in the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/LoKiFAQ#How_to_code_own_LoKi_functor">LoKi FAQ</a>):</p>
<ul>
<li><em>Particle functors</em>, which take <code>LHCb::Particle*</code> as input.</li>
<li><em>Vertex functors</em>, which take <code>LHCb::VertexBase*</code> as input.</li>
<li><em>MC particle functors</em>, which take <code>LHCb::MCParticle*</code> as input.</li>
<li><em>MC vertex functors</em>, which take <code>LHCb::MCVertex*</code> as input.</li>
<li><em>Array particle functors</em>, which take a <code>LoKi::Range_</code> (an array of particles) as input.</li>
<li><em>Track functors</em>, which take <code>LHCb::Track</code> as input.</li>
</ul>
<p>To understand what we can do with LoKi functors, we will start with exploring a <a href="05-interactive-dst.html">DST interactively</a>. Open the DST and get the first candidate in the <code>D2hhCompleteEventPromptDst2D2RS</code> line:</p>
<pre class="sourceCode python"><code class="sourceCode python">cands = evt[<span class="st">&#39;/Event/AllStreams/Phys/D2hhCompleteEventPromptDst2D2RSLine/Particles&#39;</span>]
cand = cands[<span class="dv">0</span>]</code></pre>
<p>We can now try to get very simple properties of the B candidate, such as its transverse momentum or measured mass.</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> PT, MM
<span class="dt">print</span> PT(cand)
<span class="dt">print</span> MM(cand)</code></pre>
<p>You will see an error when loading the functors</p>
<pre><code>LoKiSvc.REPORT      ERROR LoKi::AuxDesktopBase:     loadDesktop(): unable to load IPhysDesktop! StatusCode=FAILURE
LoKiSvc.REPORT      ERROR The   ERROR message is suppressed : &#39;LoKi::AuxDesktopBase:    loadDesktop(): unable to load IPhysDesktop!&#39; StatusCode=FAILURE</code></pre>
<p>This is related to the fact that some functors need to run in the <code>DaVinci</code> scope and they are all loaded in the <code>LoKiPhys.decorators</code> module, but it's harmless in the examples we will use. Additionally, if the import is made <em>before</em> the instantiation of the <code>ApplicationMgr</code>, there will be no warnings.</p>
<p>If we want to get the properties of the B vertex, for example its <span class="math"><em>Ï‡</em><sup>2</sup></span>, we need to pass the correct object to the LoKi functors</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> VCHI2
<span class="dt">print</span> VCHI2(cand.endVertex())</code></pre>
<p>This is inconvenient when running from python options, since in that case we don't have any way of calling the <code>endVertex</code> method. In that case, we can use the <code>VFASPF</code> adaptor functor, which allows to use vertex functors as if they were particle functors (note how the functor is built by combining two functors)</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> VFASPF
VCHI2(cand.endVertex()) == VFASPF(VCHI2)(cand)</code></pre>
<p>The calculation of some of the properties, such as the IP or DIRA, require the knowledge of the primary vertex associated to the candidate. In <code>GaudPython</code>, we can get the PVs ourselves.</p>
<pre class="sourceCode python"><code class="sourceCode python">pv_finder_tool = appMgr.toolsvc().create(<span class="st">&#39;GenericParticle2PVRelator&lt;_p2PVWithIPChi2, OfflineDistanceCalculatorName&gt;/P2PVWithIPChi2&#39;</span>, interface=<span class="st">&#39;IRelatedPVFinder&#39;</span>)
pvs = evt[<span class="st">&#39;/Event/AllStreams/Rec/Vertex/Primary&#39;</span>]
best_pv = pv_finder_tool.relatedPV(cand, pvs)
<span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> DIRA
<span class="dt">print</span> DIRA(best_pv)(cand)</code></pre>
<p>Given that this is a very common operation, we have the possibility of using, in the context of a <code>DaVinci</code> application (Stripping, for example), a special set of functors, starting with the <code>BPV</code> (for Best PV) prefix, which get the PV for us. Some functors also end with the suffix <code>DV</code>, which means they can only be used in the <code>DaVinci</code> context.</p>
<div id="finding-loki-functors" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Finding LoKi functors</h2>
</div>
<div class="panel-body">
<p>The full list of defined LoKi functors can be found in the <code>LoKi::Cuts</code> namespace in the <a href="http://lhcb-release-area.web.cern.ch/LHCb-release-area/DOC/davinci/releases/latest/doxygen/d7/dae/namespace_lo_ki_1_1_cuts.html">doxygen</a>. They are quite well documented with examples on how to use them. The list can be overwhelming, so it's also worth checking a more curated selection of functors in the TWiki, <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/LoKiHybridFilters">here</a> and <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/LoKiParticleFunctions">here</a>.</p>
</div>
</div>
<p>So far we've only looked at the properties of the head of the decay (that is, the D*), but what if we want to get information of its daughters? As an example, let's take get the largest transverse momentum of the final state particles. A simple solution would be to navigate the tree and calculate the maximum <code>PT</code></p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> find_tracks(particle):
    tracks = []
    <span class="kw">if</span> particle.isBasicParticle():
        proto = particle.proto()
        <span class="kw">if</span> proto:
            track = proto.track()
            <span class="kw">if</span> track:
                tracks.append(particle.data())
    <span class="kw">else</span>:
        <span class="kw">for</span> child in particle.daughters():
            tracks.extend(find_tracks(child))
    <span class="kw">return</span> tracks

max_pt = <span class="dt">max</span>([PT(child) <span class="kw">for</span> child in find_tracks(cand)])</code></pre>
<p>However, LoKi offers functions for performing such operations, namely <code>MAXTREE</code> and <code>MINTREE</code>, which get as parameters the selection criteria, the functor to calculate and a default value. In our example,</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> MAXTREE, ISBASIC, HASTRACK
MAXTREE(ISBASIC and HASTRACK, PT, -<span class="dv">1</span>)(cand) == max_pt</code></pre>
<p>In this example, we have used two selection functors, <code>ISBASIC</code> and <code>HASTRACK</code>, which return true if the particle doesn't have children and is made up by a track, respectively. We can see that they do the same thing as <code>particle.isBasicParticle()</code> and <code>particle.proto().track()</code> in a more compact way.</p>
<p>Similarly, the <code>SUMTREE</code> functor allows us to accumulate quantities for those children that pass a certain selection:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> SUMTREE, ABSID
<span class="dt">print</span> SUMTREE(<span class="dv">211</span>==ABSID, PT)(cand)
<span class="dt">print</span> SUMTREE(<span class="st">&#39;pi+&#39;</span>==ABSID, PT)(cand)</code></pre>
<p>In this case, we have summed the transverse momentum of the pions in the tree. Note the usage of the <code>ABSID</code> functor, which allows to select particles of a given ID using either their PID or their name.</p>
<p>Another very useful LoKi functor is <code>CHILD</code>, which allows to access a property of a single children of the particle. To specify which child we want, its order is used, so we need to know how the candidate was built. For example, from</p>
<pre class="output"><code>In [10]: cand.daughtersVector()
Out[10]:

 0 |-&gt;D0                           M/PT/E/PX/PY/PZ: 1.8624/ 6.4521/ 47.44/-4.939/-4.152/ 46.96 [GeV]  #  0
                                       EndVertex  X/Y/Z:0.2911/-0.2378/-14.38 [mm]  Chi2/nDoF 0.4039/1 #  0
 1    |-&gt;K-                        M/PT/E/PX/PY/PZ: 0.4937/ 2.8013/ 25.45/-1.799/-2.147/ 25.29 [GeV]  # 19
 1    |-&gt;pi+                       M/PT/E/PX/PY/PZ: 0.1396/ 3.7258/ 21.99/-3.141/-2.004/ 21.67 [GeV]  # 22
 0 |-&gt;pi+                          M/PT/E/PX/PY/PZ: 0.1396/ 0.3701/ 2.678/-0.2873/-0.2333/ 2.649 [GeV]  # 10</code></pre>
<p>we know that <code>D0</code> is the first child and <code>pi+</code> is the second. Therefore, to access the <code>PT</code> of the <code>D0</code> we have 2 options</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> LoKiPhys.decorators <span class="ch">import</span> CHILD
mass = MM(cand.daughtersVector()[<span class="dv">0</span>])
mass_child = CHILD(MM, <span class="dv">1</span>)(cand)
mass == mass_child</code></pre>
<p>The usage of LoKi functors extends much further than in the interactive <code>GaudiPython</code> world. On one side, they constitute the basis of particle filtering in the <em>selection framework</em>; on the other, they can be used directly inside our <code>DaVinci</code> jobs to store specific bits of information in our ntuples without the need for a complicated C++-based algorithms. This second option will be discussed in the <a href="12-add-tupletools.html">TupleTools and branches lesson</a>.</p>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
