<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: HowTo DecayTreeFitter</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/first-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">HowTo DecayTreeFitter</h1>
          <h2 class="subtitle">How do I use DecayTreeFitter?</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Add a kinematic fitter to a branch in the decay tree</li>
<li>Apply a mass constraint</li>
<li>Inspect the refitted decay tree</li>
</ul>
</div>
</div>
<p>Once you have made a hypothesis on the chain of decays that have lead to your final state, you then can incorporate the additional knowledge that comes with this hypothesis to get a new best estimate for the particle parameters - in particular their momenta. The additional knowledge is represented as constaints, which your decay tree has to fulfill.</p>
<p>For example for the decay</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="co">&#39;[D*(2010)+ -&gt; (D0 -&gt; K- pi+) pi+]CC&#39;</span></code></pre>
<p>you make the assumption that the (K- pi+) combine to form a D0 with a specific invariant mass. This results in a so called <em>mass-constraint</em>. In addition the kaon and the pion are supposed to originate from exactly the same point in space. If you are looking for prompt D* you can require them to come from the primary vertex. Boundary conditions like those are called <em>vertex-constraints</em>.</p>
<p>Applying such kinematic constraints leads to new best estimates for the track parameters of the final state particles. The process of calculating those is called a <em>kinematic refit</em> and the <code>TupleToolDecayTreeFitter</code> is the algorithm that performs this task for us.</p>
<div id="the-physics-and-mathematics-behind-decaytreefitter" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>The physics and mathematics behind DecayTreeFitter</h2>
</div>
<div class="panel-body">
<p>For details of the method see the paper on <a href="http://arxiv.org/abs/physics/0503191">Decay chain fitting with a Kalman filter</a>.</p>
</div>
</div>
<p>So how do we use a <code>TupleToolDecayTreeFitter</code> to our DaVinci script? Let's create a branch to add the tool to. Let's just name it <code>'Dstar'</code>:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="ch">from</span> Configurables <span class="ch">import</span> TupleToolDecayTreeFitter,TupleToolDecay
dtt.addBranches({
    <span class="st">&#39;Dstar&#39;</span> : <span class="st">&#39;[D*(2010)+ -&gt; (D0 -&gt; K- pi+) pi+]CC&#39;</span>,
}) </code></pre>
<p>To this branch we can now apply the <code>TupleToolDecayTreeFitter</code>.</p>
<pre class="sourceCode python"><code class="sourceCode python">dtt.Dstar.addTupleTool(TupleToolDecayTreeFitter(<span class="st">&#39;ConsD&#39;</span>))</code></pre>
<p>Now we can proceed with the configuration of the fitter. We are going to constrain the decay tree to the primary vertex of origin. We want all the output available, so we set the <code>verbose</code> option. Finally we want to apply the mass constraint on the D0:</p>
<pre class="sourceCode python"><code class="sourceCode python">dtt.Dstar.ConsD.constrainToOriginVertex = <span class="ot">True</span>
dtt.Dstar.ConsD.Verbose = <span class="ot">True</span>
dtt.Dstar.ConsD.daughtersToConstrain = [ <span class="st">&#39;D0&#39;</span> ]</code></pre>
<p>Note that you can constrain more than one intermediate state at once if that fits your decay.</p>
<div id="which-constraints-to-apply" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Which constraints to apply</h2>
</div>
<div class="panel-body">
<p>It is important to be aware what assumptions you bake into your ntuple. For example, after you require the vertex constraint you can't use the <code>IP_CHI2_OWNPV</code> anymore, since the particle you are looking at is <em>forced</em> to point to the PV. Which constraints make most sense for you depends on the questions you want to ask in your analysis.</p>
</div>
</div>
<p>Once you have produced your ntuple you can have a look at the refitted variables.</p>
<pre class="shell"><code>root -l DVntuple.root
TupleDstToD0pi_D0ToKpi-&gt;cd()
DecayTree-&gt;StartViewer()</code></pre>
<p>Plotting the raw mass of the D* (without the fit) <code>Dstar_MM</code> you should see a broad signal around 2 GeV:</p>
<p><img src="./img/DstarRaw.png" alt="Dstar raw" style="width: 500px;"/></p>
<p>Now let us look at the refitted mass of the D*, with the D0 constrained to its nominal mass. It is stored in the variable <code>Dstar_ConsD_M</code>. If you plot this you will note that some values are unphysical. So, let's restrict the range we look at to something that makes sense.</p>
<p>On the root prompt use the <code>arrow-up</code> key to get the last draw command and modify it to pipe the output into a histogram:</p>
<pre class="shell"><code>tv__tree-&gt;Draw(&quot;Dstar_ConsD_M&gt;&gt;h(200,2000,2030)&quot;,&quot;&quot;,&quot;&quot;);</code></pre>
<p><img src="./img/DstarRefit.png" alt="Dstar refitted" style="width: 500px;"/></p>
<p>Note that this plot has 356 entries, although we only have 128 candidates in the raw mass spectrum. The reason for this is, that we typically have several primary vertices per event. When you use the vertex contraint, the fitter is run for each of the possible vertex hypothesis available in the event. So all the <code>Dstar_ConsD-xxx</code> variables are in fact arrays, where the first value corresponds to the <em>best PV</em> hypothesis. We can plot only those by doing</p>
<pre class="shell"><code>tv__tree-&gt;Draw(&quot;Dstar_ConsD_M[0]&gt;&gt;h(200,2000,2030)&quot;,&quot;&quot;,&quot;&quot;);</code></pre>
<p>and we get the final kinematically refitted Dstar mass:</p>
<p><img src="./img/DstarRefitBest.png" alt="Dstar refitted best PV" style="width: 500px;"/></p>
<p>Finally, let's check how the D0 mass constraint has played out.</p>
<pre class="shell"><code>tv__tree-&gt;Draw(&quot;Dstar_ConsD_D0_M[0]&gt;&gt;h(100,1800,1900)&quot;,&quot;&quot;,&quot;&quot;, 128, 0);</code></pre>
<p><img src="./img/D0Refit.png" alt="constrained D0" style="width: 500px;"/></p>
<p>As expected, the D0 candidates are forced onto their PDG mass value.</p>
<p>The solution to this exercise <code>ntuple_DTF1.py</code>, is <a href="./code/22-decay-tree-fitter/ntuple_DTF1.py">available here</a>.</p>
<div id="explore" class="challenge panel panel-success">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pencil"></span>Explore</h2>
</div>
<div class="panel-body">
<ul>
<li>Look at the <code>status</code> variable to check if the fits converged.</li>
<li>Look at the chi2 distribution of the fit</li>
</ul>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
