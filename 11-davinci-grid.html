<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: First Steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/first-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">First Steps in LHCb</h1>
          <h2 class="subtitle">Minimal DaVinci on the grid</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Create a ganga job</li>
<li>Submit a ganga job</li>
<li>Waiting for ganga</li>
<li>Find the job output</li>
</ul>
</div>
</div>
<p>This lesson will teach you how to take our <a href="09-minimal-dv-job.html">minimal DaVinci job</a> and run it on the grid.</p>
<p><code>ganga</code> is a program which you can use to interact with your grid jobs. Start it with:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">SetupProject</span> Ganga
$ <span class="kw">ganga</span></code></pre>
<p>After <code>ganga</code> has started you will be dropped into something that looks very much like an <code>ipython</code> session. <code>ganga</code> is built on top of <code>ipython</code> so you can type anything that is legal <code>python</code> in addition to some special commands provided by <code>ganga</code>.</p>
<p>To create your first <code>ganga</code> job type the following:</p>
<pre class="sourceCode python"><code class="sourceCode python">j = Job(application=DaVinci(version=<span class="st">&#39;v36r6&#39;</span>))
j.backend = Dirac()
j.name = <span class="st">&quot;First ganga job&quot;</span>
j.inputdata = j.application.readInputData(<span class="st">&#39;data/MC_2012_27163003_Beam4000GeV2012MagDownNu2.5Pythia8_Sim08e_Digi13_Trig0x409f0045_Reco14a_Stripping20NoPrescalingFlagged_ALLSTREAMS.DST.py&#39;</span>)
j.application.optsfile = <span class="st">&#39;code/11-davinci-grid/ntuple_options_grid.py&#39;</span></code></pre>
<p>This will create a <code>Job</code> object that will execute <code>DaVinci</code> using a backend called <code>Dirac</code>, which is &quot;the grid&quot;. Instead of specifying the files to process as part of the options file you have now tell the <code>Job</code> about it. This means allows <code>ganga</code> to split your job up, processing different files simultaneously. The final property to set is the <code>j.application.optsfile</code> which specifies the options file to use to configure the job.</p>
<p>Now you have created your first job, however it has not started running yet. To submit it type <code>j.submit()</code>. Now <code>ganga</code> will do the equivalent of <code>SetupProject DaVinci v36r6</code>, prepare your job and then ship it off to the grid.</p>
<p>While it runs, let's submit an identical job via slightly different method. Having to type in the details of each job every time you want to run it is error prone and tedious. Instead you can place all the lines that define a job in a file and simply run that.</p>
<p>Place the following in a file called <a href="code/11-davinci-grid/first-job.py"><code>first-job.py</code></a>:</p>
<pre class="sourceCode python"><code class="sourceCode python">j = Job(application=DaVinci(version=<span class="st">&#39;v36r6&#39;</span>))
j.backend = Dirac()
j.name = <span class="st">&quot;First ganga job&quot;</span>
j.inputdata = j.application.readInputData(<span class="st">&#39;data/MC_2012_27163003_Beam4000GeV2012MagDownNu2.5Pythia8_Sim08e_Digi13_Trig0x409f0045_Reco14a_Stripping20NoPrescalingFlagged_ALLSTREAMS.DST.py&#39;</span>)
j.application.optsfile = <span class="st">&#39;code/11-davinci-grid/ntuple_options_grid.py&#39;</span>
j.submit()</code></pre>
<p>Which you can execute and submit like so, from within a <code>ganga</code> session:</p>
<pre class="sourceCode python"><code class="sourceCode python">%ganga first-job.py</code></pre>
<p>This will print output similar to submitting the job from with in <code>ganga</code>.</p>
<p>You can check on your jobs by typing <code>jobs</code> into a <code>ganga</code> console. This will list all of your jobs, their status, what kind of application they are and more.</p>
<p>You can get more detailed information about your job by typing <code>jobs($jobid)</code>. Replacing <code>$jobid</code> with the <code>id</code> of the job you are interested in. For concretness we will assume you are interested in a job with jobid 787 in this example.</p>
<p>Once your job has finished its status will be <code>completed</code>. Check this by typing <code>jobs</code> or by printing out the status of one particular job:</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="dt">print</span> <span class="st">&quot;Status of my job:&quot;</span>, jobs(<span class="dv">787</span>).status</code></pre>
<p>The next thing to do is to find the output of your job. Two things can happen to files your job creates:</p>
<ul>
<li>They get downloaded by <code>ganga</code>, or</li>
<li>they are stored &quot;on the grid&quot;.</li>
</ul>
<p>By default <code>ganga</code> will download most files below a size of XX MB. The rest will remain on the grid. Log files will almost always be downloaded.</p>
<p>To find where the files <code>ganga</code> downloaded are you can check the <code>outputdir</code> property of your job.</p>
<pre class="sourceCode python"><code class="sourceCode python">output = job(<span class="dv">787</span>).outputdir
<span class="dt">print</span> <span class="st">&quot;Job output stored in:&quot;</span>, output</code></pre>
<p>Take a look at the contents of this directory.</p>
<div id="using-the-shell-from-ipython" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Using the Shell from IPython</h2>
</div>
<div class="panel-body">
<p>IPython lets you execute shell commands from within the <code>ganga</code> session. This means you can list the contents of a directory without leaving ganga by typing <code>!ls /tmp/</code>. This will list the contents of the <code>/tmp</code> directory. In our case we can use this to list the contents of the job output directory with <code>!ls $output</code> as we stored the path in the variable <code>output</code>.</p>
</div>
</div>
<p>To look at the <code>root</code> file produced by the job start a new terminal, and type:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">lb-run</span> DaVinci v36r6 <span class="ot">$SHELL</span>
$ <span class="kw">root</span> -l path/to/the/job/output</code></pre>
<p>You need to setup <code>DaVinci</code> as we need ROOT version 6 to read the nTuple.</p>
<div id="getting-help-with-ganga" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Getting help with ganga</h2>
</div>
<div class="panel-body">
<p>To find out more take a look at the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/GangaLHCbFAQ">Ganga FAQ</a></p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
